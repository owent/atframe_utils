name: "main"

on: # @see https://help.github.com/en/articles/events-that-trigger-workflows#webhook-events
  push:
    branches: # Array of patterns that match refs/heads
      - main
  pull_request:
    branches: [ main ]

jobs:
  format:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: CI Job
        shell: bash
        run: |
          bash ci/do_ci.sh format ;
  unix_build: # job id, can be any string
    name: Unix Build
    # This job runs on Linux
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            triplet: x64-linux
            cc: gcc
          - os: ubuntu-latest
            triplet: x64-linux
            cc: gcc
            ci_mode: mbedtls
          - os: ubuntu-latest
            triplet: x64-linux
            cc: gcc
            ci_mode: libressl
          - os: ubuntu-latest
            triplet: x64-linux
            cc: gcc
            ci_mode: boringssl
          - os: ubuntu-latest
            triplet: x64-linux
            cc: gcc
            ci_mode: openssl-1.1.1
          - os: ubuntu-latest
            triplet: x64-linux
            cc: gcc
            ci_mode: no-rtti
          - os: ubuntu-latest
            triplet: x64-linux
            cc: gcc
            ci_mode: no-exceptions
          - os: ubuntu-latest
            triplet: x64-linux
            cc: gcc-latest
          - os: ubuntu-18.04
            triplet: x64-linux
            cc: gcc-4.8
          - os: ubuntu-latest
            triplet: x64-linux
            cc: clang-latest
          - os: macos-latest
            triplet: x64-osx
            cc: clang-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Build & Test
        shell: bash
        env:
          USE_CC: ${{ matrix.cc }}
          VCPKG_TARGET_TRIPLET: ${{ matrix.triplet }}
          CI_MODE: ${{ matrix.ci_mode }}
        run: |
          if [[ "xgcc-4.8" == "x$USE_CC" ]]; then
            sudo apt-get update ;
            sudo apt-get install --no-install-recommends --no-install-suggests -y g++-4.8 ;
            bash ci/do_ci.sh gcc.legacy.test ;
          elif [[ "x$CI_MODE" == "xno-rtti" ]]; then
            bash ci/do_ci.sh gcc.no-rtti.test ;
          elif [[ "x$CI_MODE" == "xno-exceptions" ]]; then
            bash ci/do_ci.sh gcc.no-exceptions.test ;
          elif [[ "x$CI_MODE" == "xmbedtls" ]]; then
            bash ci/do_ci.sh ssl.mbedtls ;
          elif [[ "x$CI_MODE" == "xlibressl" ]]; then
            bash ci/do_ci.sh ssl.libressl ;
          elif [[ "x$CI_MODE" == "xboringssl" ]]; then
            bash ci/do_ci.sh ssl.boringssl ;
          elif [[ "x$CI_MODE" == "xopenssl-1.1.1" ]]; then
            bash ci/do_ci.sh ssl.openssl-1.1.1 ;
          else
            bash ci/do_ci.sh ssl.openssl ;
          fi
      - name: Cache packages
        uses: actions/cache@v2
        with:
          path: |
            /usr/local/share/vcpkg/installed
            third_party/install
          key: ${{ runner.os }}-${ hashFiles('.github/.cache-key') }-${{ hashFiles('/usr/local/share/vcpkg/installed/**') }}
  vs2019_2022_build: # job id, can be any string
    name: Visual Studio 2019/2022 Build
    strategy:
      matrix:
        include:
          - os: windows-latest
            generator: "Visual Studio 17 2022"
            build_shared_libs: "ON"
            platform: x64
          - os: windows-latest
            generator: "Visual Studio 17 2022"
            build_shared_libs: "ON"
            platform: x64
            ci_mode: no-rtti
          - os: windows-latest
            generator: "Visual Studio 17 2022"
            build_shared_libs: "ON"
            platform: x64
            ci_mode: no-exceptions
          - os: windows-latest
            generator: "Visual Studio 17 2022"
            build_shared_libs: "OFF"
            platform: x64
          - os: windows-2019
            generator: "Visual Studio 16 2019"
            build_shared_libs: "ON"
            platform: x64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Build & Test
        shell: pwsh
        env:
          CMAKE_GENERATOR: ${{ matrix.generator }}
          CMAKE_PLATFORM: ${{ matrix.platform }}
          BUILD_SHARED_LIBS: ${{ matrix.build_shared_libs }}
          CONFIGURATION: RelWithDebInfo
          CI_MODE: ${{ matrix.ci_mode }}
        run: |
          if ($ENV:CI_MODE -eq "no-rtti") {
            pwsh ci/do_ci.ps1 msvc.no-rtti.test ;
          } elseif($ENV:CI_MODE -eq "no-exceptions") {
            pwsh ci/do_ci.ps1 msvc.no-exceptions.test ;
          } else {
            pwsh ci/do_ci.ps1 "msvc.2019+.test" ;
          }
      - name: Cache packages
        uses: actions/cache@v2
        with:
          path: |
            third_party/install
          key: ${{ runner.os }}-${ hashFiles('.github/.cache-key') }
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Build & Test
        shell: pwsh
        env:
          CMAKE_GENERATOR: ${{ matrix.generator }}
          BUILD_SHARED_LIBS: ${{ matrix.build_shared_libs }}
          CONFIGURATION: Debug
        run: |
          pwsh ci/do_ci.ps1 msvc.2017.test ;
      - name: Cache packages
        uses: actions/cache@v2
        with:
          path: |
            third_party/install
          key: ${{ runner.os }}-${ hashFiles('.github/.cache-key') }
  mingw_build: # job id, can be any string
    name: MinGW Build
    strategy:
      matrix:
        include:
          - os: windows-latest
            build_shared_libs: "ON"
          - os: windows-latest
            build_shared_libs: "OFF"
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Build & Test
        shell: bash
        env:
          BUILD_SHARED_LIBS: ${{ matrix.build_shared_libs }}
        run: |
          C:/msys64/msys2_shell.cmd -mingw64 -defterm -no-start -here -lc "ci/do_ci.sh msys2.mingw.test"
      - name: Cache packages
        uses: actions/cache@v2
        with:
          path: |
            third_party/install
          key: ${{ runner.os }}-${ hashFiles('.github/.cache-key') }
  coverage: # job id, can be any string
    name: Coverage
    # This job runs on Linux
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            triplet: x64-linux
            cc: gcc
            gcov_flags: "--coverage -fprofile-arcs -ftest-coverage"
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Generate coverage
        shell: bash
        env:
          USE_CC: ${{ matrix.cc }}
          VCPKG_TARGET_TRIPLET: ${{ matrix.triplet }}
          USE_SSL: ${{ matrix.ssl }}
          GCOV_FLAGS: "${{ matrix.gcov_flags }}"
        run: |
          bash ci/do_ci.sh coverage ;
      - name: Uploaded code coverage
        uses: codecov/codecov-action@v1
        with:
          # token: ${{secrets.CODECOV_TOKEN}} # not required for public repos
          fail_ci_if_error: true
          gcov_args: '-lp'
      - name: Cache packages
        uses: actions/cache@v2
        with:
          path: |
            /usr/local/share/vcpkg/installed
            third_party/install
          key: ${{ runner.os }}-${ hashFiles('.github/.cache-key') }-${{ hashFiles('/usr/local/share/vcpkg/installed/**') }}